<!--
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../components/iron-icon/iron-icon.html">
<link rel="import" href="../components/iron-input/iron-input.html">
<link rel="import" href="../components/iron-icons/iron-icons.html">
<link rel="import" href="../components/iron-icons/av-icons.html">
<link rel="import" href="../components/paper-input/paper-input.html">
<link rel="import" href="../components/paper-input/paper-input-container.html">
<link rel="import" href="../components/paper-item/paper-item.html">
<link rel="import" href="../components/voice-elements/dist/voice-recognition.html">
<link rel="import" href="../components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../components/paper-item/paper-item-body.html">
<link rel="import" href="../components/paper-fab/paper-fab.html">
<link rel="import" href="/elements/mic-icon.html">
<link rel="import" href="/elements/api-ai-api.html">

<link rel="import" href="input-header.html">

<dom-module id="chat-thread-view">

  <template>

    <style>
      :host {
        @apply(--layout-vertical);
      }
      .list {
        @apply(--layout-flex);
        overflow: auto;
      }
      paper-input {
        padding: 10px;
      }
    </style>

    
    <api-ai-api id="api"
                access-token="[[accessToken]]"
                lang="[[lang]]"
                session-id="[[_sessionId]]"
                message="{{_message}}"
                last-response="{{_response}}"
                on-response="_handleResponse"
    ></api-ai-api>

    <div class="list">
      <template is="dom-repeat" items="[[_conversation]]">
        <paper-item>
          <paper-item-body two-line>
            <div>{{item.who}}</div>
            <div secondary>{{item.message}}</div>
          </paper-item-body>
        </paper-item>
      </template>
    </div>
    

     <paper-input-container>
      <label>[[label]]</label>
      <input is="iron-input" bind-value="{{value}}" on-keydown="_checkForEnter">
      <paper-icon-button suffix
                         icon="api-ai:mic"
                         hidden$="[[!_micAvailable(noVoice, _speechRecognition, _recording)]]"
                         on-tap="_startRecognition"
      ></paper-icon-button>
      <paper-icon-button suffix
                         icon="api-ai:mic-off"
                         hidden$="[[!_recording]]"
                         on-tap="_stopRecognition"
      ></paper-icon-button>
      <paper-icon-button suffix icon="api-ai:send" on-tap="_send"></paper-icon-button>
    </paper-input-container>
    <!-- <voice-recognition id="voice" continuous="false" on-start="_start" on-end="_finish"></voice-recognition> -->
  </template>

  <script>
    Polymer({

      is: 'chat-thread-view',

      properties: {

        /*
         * Label of the input element
         */
        label: {
          type: String,
          value: 'Message to API.AI Agent'
        },

        /*
         * Current content of the input element for two-way binding
         */
        value: {
          type: String,
          notify: true
        },

        /*
         * Disable speech-recognition for the element
         */
        noVoice: {
          type: Boolean,
          value: false
        },

        /*
         * Language code for speech recognition. Should match the API.AI agent's language
         */
        lang: {
          type: String,
          value: 'en'
        },

        /*
         * true = browser supports speech recognition with the Web Speech API
         */
        _speechRecognition: {
          type: Boolean,
          value: function () {
            return (!!window.SpeechRecognition || !!window.webkitSpeechRecognition);
          }
        },

        /*
         * true = Speech recogntion is currently running
         */
        _recording: {
          type: Boolean,
          value: false
        },
        accessToken: String,
        lang: {
          type: String,
          value: 'en'
        },
        _sessionId: String,
        _message: String,
        _response: Object,
        _conversation: {
          type: Array,
          value: function () {
            return [];
          }
        }


      },

      ready: function () {
        this._sessionId = Math.random().toString(36).replace(/[^a-z]+/g, '');
      },
      _send: function () {
        console.log('ENTRO', this.value)
        if (!this.value) {
          return;
        }
        this.unshift('_conversation', {
          in: false,
          who: 'You',
          message: this.value
        });
        this.$.api.send();
        this.set('value', '');
      },

      _handleResponse: function () {
        this.unshift('_conversation', {
          in: true,
          who: 'API.AI',
          message: this._response.result.fulfillment.speech
        });
      },

     

      /*
       *  Whether to show Microphone icon or not
       */
      _micAvailable: function (noVoice, speechRecognition, recording) {
        return (!noVoice && speechRecognition && !recording);
      },

      /*
       * Start speech recognition
       */
      _startRecognition: function () {
        var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        this._recognition = new SpeechRecognition();

        this._recognition.onstart = function () {
          this.set('value', '');
          this.set('_recording', true);
        }.bind(this);

        this._recognition.onresult = function(event) {
          var text = '';
          for (var i = event.resultIndex; i < event.results.length; ++i) {
            text += event.results[i][0].transcript;
          }
          this.set('value', text);
          this._stopRecognition();
        }.bind(this);

        this._recognition.onend = function() {
          this._finishRecognition();
        }.bind(this);

        this._recognition.lang = this.lang;
        this._recognition.start();
      },

      /*
       * Fires when a value is ready to be sent
       *
       * @event value-ready
       */

      /*
       * Stop speech recognition
       */
      _stopRecognition: function () {
        if (this._recognition) {
          this._recognition.stop();
        }
      },

      /*
       * Clean-up after speech recognition
       */
      _finishRecognition: function () {
        this._recognition = null;
        this.set('_recording', false);
        this._send();
      },

      _checkForEnter: function (e) {
        if (e.keyCode === 13) {
          this._send();
        }
      }

     

    });
  </script>

</dom-module>

